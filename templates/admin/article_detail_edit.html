{% extends "base.html" %}

{% block head %}
    {% include 'partials/head.html' %}
    <title>Edit Article Detail - Admin - Sermitsiaq</title>
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }
        .admin-header {
            margin-bottom: 30px;
        }
        .admin-header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .breadcrumb {
            margin-bottom: 20px;
        }
        .breadcrumb a {
            color: #007bff;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .form-group textarea {
            min-height: 500px;
            font-size: 14px;
            line-height: 1.5;
        }
        .form-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .info-box p {
            margin: 5px 0;
        }
        .info-box strong {
            color: #333;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary {
            background: #28a745;
            color: white;
        }
        .btn-primary:hover {
            background: #218838;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .json-editor-wrapper {
            position: relative;
        }
        .json-validator {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .json-validator.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .json-validator.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
    </style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div class="breadcrumb">
            <a href="{{ url_for('admin.list_article_details') }}">← Back to List</a>
        </div>
        <h1>Edit Article Detail</h1>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <div class="info-box">
            <p><strong>ID:</strong> {{ article_detail.id }}</p>
            <p><strong>Published URL:</strong> {{ article_detail.published_url }}</p>
            <p><strong>Language:</strong> {{ article_detail.language|upper }}</p>
            {% if article %}
                <p><strong>Article Title:</strong> {{ article.title }}</p>
            {% endif %}
            <p><strong>Last Updated:</strong> {{ article_detail.updated_at.strftime('%Y-%m-%d %H:%M:%S') if article_detail.updated_at else 'Never' }}</p>
        </div>

        <form method="POST" action="{{ url_for('admin.update_article_detail', detail_id=article_detail.id) }}" id="edit-form">
            <div class="form-group">
                <label for="content_blocks">Content Blocks (JSON):</label>
                <div class="json-editor-wrapper">
                    <textarea 
                        id="content_blocks" 
                        name="content_blocks" 
                        required
                        spellcheck="false"
                    >{{ content_blocks_json }}</textarea>
                    <div id="json-validator" class="json-validator"></div>
                </div>
                <div class="help-text">
                    Edit the JSON array of content blocks. Each block should have a "type" field (paragraph, heading, image, ad, etc.) and an "order" field.
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="{{ url_for('admin.view_article_detail', detail_id=article_detail.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // JSON validation
    const textarea = document.getElementById('content_blocks');
    const validator = document.getElementById('json-validator');
    
    function validateJSON() {
        const value = textarea.value.trim();
        if (!value) {
            validator.className = 'json-validator error';
            validator.textContent = 'JSON cannot be empty';
            return false;
        }
        
        try {
            const parsed = JSON.parse(value);
            if (!Array.isArray(parsed)) {
                validator.className = 'json-validator error';
                validator.textContent = 'Content blocks must be a JSON array';
                return false;
            }
            validator.className = 'json-validator success';
            validator.textContent = '✓ Valid JSON array';
            return true;
        } catch (e) {
            validator.className = 'json-validator error';
            validator.textContent = 'Invalid JSON: ' + e.message;
            return false;
        }
    }
    
    // Validate on input
    textarea.addEventListener('input', validateJSON);
    
    // Validate on form submit
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        if (!validateJSON()) {
            e.preventDefault();
            alert('Please fix JSON errors before submitting');
            return false;
        }
    });
    
    // Initial validation
    validateJSON();
</script>
{% endblock %}

