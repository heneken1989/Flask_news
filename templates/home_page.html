{% extends "base.html" %}

{% block extra_head %}
    {# Additional CSS cho home page #}
    <style>
        /* Lo·∫°i b·ªè underline cho headlines khi hover */
        article a:hover,
        article a:hover h2,
        article a:hover .headline {
            text-decoration: none !important;
        }
        article a {
            text-decoration: none;
        }
        
        /* SwipeHelper styles - t·ª´ _swipehelper.scss */
        .swipehelper {
            overflow: auto;
            overflow: -moz-scrollbars-none;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .swipehelper::-webkit-scrollbar {
            width: 0 !important;
        }
        .swipehelper.snap-container-x {
            scroll-snap-type: x mandatory;
        }
        .swipehelper.snap-container-y {
            scroll-snap-type: y mandatory;
        }
        .swipehelper.snap-element-start .snap-element {
            scroll-snap-align: start;
        }
        .swipehelper.snap-element-center .snap-element {
            scroll-snap-align: center;
        }
        
        /* Articlescroller styles - t·ª´ _articlescroller.scss */
        .articlescroller .scroll-container {
            overflow-x: scroll;
            display: flex;
            position: relative;
            user-select: none;
            margin-right: -0.7rem;
            margin-left: -0.7rem;
            transition: transform 0.6s;
            transition-duration: 0.6s;
        }
        .articlescroller .scroll-container.transition-linear {
            transition-timing-function: linear;
        }
        .articlescroller .scroll-item {
            flex: 0 0 auto;
            transition: inherit;
            transform: translateX(0);
            will-change: transform;
            overflow: hidden;
        }
        .articlescroller .scroll-item img {
            width: 100%;
            display: inline;
        }
        .articlescroller .scroll-item h3 {
            font-size: 1.2em;
            font-weight: 600;
            padding: 0.2em 0 0.2em;
        }
        .articlescroller .scroll-item h4 {
            font-size: 1em;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .articlescroller .scroll-item a {
            color: inherit;
            text-decoration: none;
        }
        .articlescroller .scroll-item a:hover h3 {
            text-decoration: underline;
        }
        
        /* Count classes - hi·ªÉn th·ªã s·ªë items per view */
        .articlescroller ul.count_1 li {
            flex-basis: 100%;
        }
        .articlescroller ul.count_2 li {
            flex-basis: 50%;
        }
        .articlescroller ul.count_3 li {
            flex-basis: 33.33%;
        }
        .articlescroller ul.count_4 li {
            flex-basis: 25%;
        }
        .articlescroller ul.count_5 li {
            flex-basis: 20%;
        }
        .articlescroller ul.count_5 li {
            flex-basis: 20%;
        }
        .articlescroller ul.count_6 li {
            flex-basis: 16.66%;
        }
        
        /* Nav buttons */
        .articlescroller .inner {
            position: relative;
            overflow: hidden;
        }
        .articlescroller nav .arrow {
            position: absolute;
            top: 50%;
            left: 10px;
            border-radius: 100%;
            background-color: rgba(0,0,0,0.5);
            transform: translateY(-70%);
            cursor: pointer;
            border: 1px solid transparent;
            z-index: 10;
        }
        .articlescroller nav .arrow:hover {
            border-color: #fff;
        }
        .articlescroller nav .arrow span {
            border-bottom: 2px solid #fff;
            border-left: 2px solid #fff;
            width: 1rem;
            height: 1rem;
            display: block;
            margin: 1.2rem;
            transform: translateX(0.2rem) rotate(45deg);
        }
        .articlescroller nav .arrow.right {
            left: auto;
            right: 10px;
        }
        .articlescroller nav .arrow.right span {
            transform: translateX(-0.2rem) rotate(-135deg);
        }
        .articlescroller nav .arrow.nav-hidden {
            opacity: 0;
        }
        
        /* Mobile styles */
        @media (max-width: 767px) {
            .articlescroller nav .arrow {
                top: 10%;
                left: 0;
            }
            .articlescroller nav .arrow span {
                width: 0.5rem;
                height: 0.5rem;
                margin: 0.6rem;
            }
            .articlescroller nav .arrow.right {
                right: 0;
            }
        }
    </style>
{% endblock %}

{% block body_class %}l4 front site_sermitsiaq section_{{ section|default('home') }} iteras-paywall{% endblock %}

{% block content %}
    {# Main Body v·ªõi Home Layouts - Wrap trong section.main.front gi·ªëng c√°c trang tag #}
    <section class="main front">
        {% set layouts = layouts|default([]) %}
        {% set section_title = section_title|default('') %}
        {% set show_top_ad = show_top_ad|default(true) %}
        {% set show_bottom_ad = show_bottom_ad|default(false) %}
        
        {% if section_title %}
        <h1 class="hidden-heading">{{ section_title }}</h1>
        {% endif %}
        
        {# Top Ad Placeholder (optional) #}
        {% if show_top_ad %}
        <div data-element-guid="{{ top_ad_guid|default('') }}" class="placeholder placement-top">
            <div data-element-guid="{{ top_ad_column_guid|default('') }}" class="column google-ad small-12 large-12 small-abs-12 large-abs-12" style="">
                <span class="ad-label">{{ _('Advertisement') }}</span>
                <div class="adunit" id="2018-Top-Mega-banner"></div>
                <script>
                    googletag.cmd.push(function() {
                        googletag.display('2018-Top-Mega-banner');
                    });
                </script>
            </div>
        </div>
        {% endif %}
        
        {# Page Content - Home Layouts #}
        <div data-element-guid="{{ page_content_guid|default('17215aad-5762-4420-b4b6-23b738f459f4') }}" class="page-content">
            {# Render t·ª´ng layout #}
            {% for layout in layouts %}
        {% set layout_type = layout.layout_type %}
        {% set row_guid = layout.row_guid %}
        {% set data = layout.data %}
        
        {% if layout_type == '1_full' %}
            {% set article = data.article %}
            {% include 'partials/layout_1_article_full.html' %}
            
        {% elif layout_type == '2_articles' %}
            {% set articles = data.articles %}
            {% include 'partials/layout_2_articles.html' %}
            
        {% elif layout_type == '3_articles' %}
            {% set articles = data.articles %}
            {% include 'partials/layout_3_articles.html' %}
            
        {% elif layout_type == '1_special_bg' %}
            {% set article = data.article %}
            {% set kicker = data.kicker %}
            {% include 'partials/layout_1_article_special_bg.html' %}
            
        {% elif layout_type == '1_with_list_left' %}
            {% set article = data.article %}
            {% set list_title = data.list_title %}
            {% set list_items = data.list_items %}
            {% set list_position = 'left' %}
            {% include 'partials/layout_article_with_list.html' %}
            
        {% elif layout_type == '1_with_list_right' %}
            {% set article = data.article %}
            {% set list_title = data.list_title %}
            {% set list_items = data.list_items %}
            {% set list_position = 'right' %}
            {% include 'partials/layout_article_with_list.html' %}
            
        {% elif layout_type == 'slider' %}
            {% set slider_title = data.slider_title %}
            {% set slider_articles = data.slider_articles %}
            {% set slider_id = data.slider_id %}
            {% include 'partials/layout_slider.html' %}
            
        {% elif layout_type == 'job_slider' %}
            {% set slider_title = data.slider_title %}
            {% set slider_articles = data.slider_articles %}
            {% set slider_id = data.slider_id %}
            {% set header_link = data.header_link %}
            {% set extra_classes = data.extra_classes %}
            {% set header_classes = data.header_classes %}
            {% set source_class = data.source_class %}
            {% set has_nav = data.has_nav %}
            {% set items_per_view = data.items_per_view %}
            {% include 'partials/layout_job_slider.html' %}
            
        {% elif layout_type == '5_articles' %}
            {% set articles = data.articles %}
            {% include 'partials/layout_5_articles.html' %}
            
        {% else %}
            {# Fallback: render as 1_full #}
            {% set article = data.article if data.article else (data.articles[0] if data.articles else {}) %}
            {% include 'partials/layout_1_article_full.html' %}
        {% endif %}
            {% endfor %}
        </div>
        
        {# Bottom Ad Placeholder (optional) #}
        {% if show_bottom_ad %}
        <div data-element-guid="{{ bottom_ad_guid|default('') }}" class="placeholder placement-bottom">
            <div data-element-guid="{{ bottom_ad_column_guid|default('') }}" class="column google-ad small-12 large-12 small-abs-12 large-abs-12" style="">
                <span class="ad-label">{{ _('Advertisement') }}</span>
                <div class="adunit" id="2018-Sticky-right"></div>
                <script>
                    googletag.cmd.push(function() {
                        googletag.display('2018-Sticky-right');
                    });
                </script>
            </div>
        </div>
        {% endif %}
    </section>
{% endblock %}

{% block scripts %}
    {# Base scripts from article.html if needed #}
    <script src="/view-resources/baseview/public/common/build/baseview_dependencies_dom.js?v=1768293024-L4" data-cookieconsent="ignore"></script>
    
    <script>
        // Kh·ªüi t·∫°o handlers cho dachserData (gi·ªëng nh∆∞ home.html)
        window.dachserData.handlers = {
            parallax: function(item) {
                if (window.Dac && window.Dac.Parallax) {
                    new Dac.Parallax(item);
                } else {
                    console.warn('parallax: Missing required class Dac.Parallax. Content will not animate.');
                }
            },
            swipehelper: function(item) {
                if (window.Dac && window.Dac.SwipeHelper) {
                    var element = document.querySelector(item.selector);
                    if (!element) {
                        console.warn('SwipeHelper: Missing element for selector: "' + item.selector + '".');
                        return null;
                    }
                    return new Dac.SwipeHelper(element, item);
                } else {
                    console.warn('SwipeHelper: Missing required function Dac.SwipeHelper.');
                    return null;
                } 
            },
            readprogress: function(item) {
                if (window.Dac && window.Dac.ReadProgress) {
                    var element = document.querySelector(item.selector);
                    if (!element) {
                        console.warn('ReadProgress: Missing element for selector: "' + item.selector + '".');
                        return;
                    }
                    new Dac.ReadProgress(element, item);
                } else {
                    console.warn('ReadProgress: Missing required function Dac.ReadProgress.');
                } 
            },
            tabnavigation: function(item) {
                if (window.Dac && window.Dac.TabNavigation) {
                    new Dac.TabNavigation(item);
                } else {
                    console.warn('TabNavigation: Missing required function Dac.Tabnavigation.');
                } 
            },
            elementattributetoggler: function(item) {
                if (window.Dac && window.Dac.ElementAttributeToggler) {
                    new Dac.ElementAttributeToggler(item);
                } else {
                    console.warn('ElementAttributeToggler: Missing required class Dac.ElementAttributeToggler.');
                } 
            },
            articlelists: (item) => {
                if (window.Dac && window.Dac.ArticleLists) {
                    new Dac.ArticleLists(item);
                } else {
                    console.warn('ElementAttributeToggler: Missing required class Dac.ArticleLists.');
                }
            }
        };

        window.dachserData.execute = () => {
            // Parallax
            const parallaxQueue = window.dachserData.get('parallax') || [];
            parallaxQueue.forEach(item => {
                window.dachserData.handlers.parallax(item);
            });
        
            // SwipeHelper, used by several components like ArticleScroller etc.
            // Register each element using SwipeHelper:
            const swipehelperQueue = window.dachserData.get('swipehelper') || [];
            console.log('üé† Initializing', swipehelperQueue.length, 'sliders');
            swipehelperQueue.forEach((item, idx) => {
                console.log(`  Slider ${idx + 1}: selector = ${item.selector}`);
                const instance = window.dachserData.handlers.swipehelper(item);
                if (instance) {
                    window.dachserData.setInstance(
                        'swipehelper',
                        item.selector,
                        instance
                    );
                    console.log(`  ‚úÖ Slider ${idx + 1} initialized successfully`);
                } else {
                    console.warn(`  ‚ö†Ô∏è  Slider ${idx + 1} failed to initialize`);
                }
            });

            // ReadProgress
            const readprogressQueue = window.dachserData.get('readprogress') || [];
            readprogressQueue.forEach(item => {
                window.dachserData.handlers.readprogress(item);
            });
        
            // Tab-navigation
            const tabnavigationQueue = window.dachserData.get('tabnavigation') || [];
            tabnavigationQueue.forEach(item => {
                window.dachserData.handlers.tabnavigation(item);
            });

            // ElementAttributeToggler
            const elementAttributeTogglerQueue = window.dachserData.get('elementattributetoggler') || [];
            elementAttributeTogglerQueue.forEach(item => {
                window.dachserData.handlers.elementattributetoggler(item);
            });

            const articlelistsQueue = window.dachserData.get('articlelists') || [];
            articlelistsQueue.forEach(item => {
                window.dachserData.handlers.articlelists(item);
            });
        };

        // ƒê·ª£i DOM ready v√† t·∫•t c·∫£ scripts ƒë√£ load tr∆∞·ªõc khi execute
        (function () {
            function initDachserData() {
                // Ki·ªÉm tra xem Dac.SwipeHelper ƒë√£ load ch∆∞a
                if (window.Dac && window.Dac.SwipeHelper) {
                    window.dachserData.execute();
                } else {
                    // N·∫øu ch∆∞a load, ƒë·ª£i th√™m m·ªôt ch√∫t
                    setTimeout(initDachserData, 100);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // ƒê·ª£i th√™m m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ slider scripts ƒë√£ ƒë∆∞·ª£c push
                    setTimeout(initDachserData, 200);
                    // Kh·ªüi t·∫°o custom slider navigation
                    setTimeout(initSliderNavigation, 300);
                });
            } else {
                // DOM ƒë√£ ready, ƒë·ª£i th√™m m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ slider scripts ƒë√£ ƒë∆∞·ª£c push
                setTimeout(initDachserData, 200);
                // Kh·ªüi t·∫°o custom slider navigation
                setTimeout(initSliderNavigation, 300);
            }
        }());
        
        // H√†m t·ª± build ƒë·ªÉ x·ª≠ l√Ω slider navigation buttons
        function initSliderNavigation() {
            console.log("üé† Initializing custom slider navigation...");
            
            // T√¨m t·∫•t c·∫£ c√°c slider tr√™n trang
            const sliders = document.querySelectorAll('.articlescroller');
            
            sliders.forEach((slider, sliderIndex) => {
                console.log(`  Processing slider ${sliderIndex + 1}...`);
                
                // T√¨m scroll container v√† nav buttons trong slider n√†y
                const scrollContainer = slider.querySelector('.scroll-container');
                const navLeft = slider.querySelector('nav .arrow.left');
                const navRight = slider.querySelector('nav .arrow.right');
                
                if (!scrollContainer) {
                    console.warn(`  ‚ö†Ô∏è  Slider ${sliderIndex + 1}: No scroll-container found`);
                    return;
                }
                
                // N·∫øu kh√¥ng c√≥ nav buttons, skip slider n√†y (v√≠ d·ª•: slider NUUK)
                if (!navLeft || !navRight) {
                    console.log(`  ‚ÑπÔ∏è  Slider ${sliderIndex + 1}: No nav buttons (static slider, e.g. NUUK)`);
                    return;
                }
                
                console.log(`  ‚úÖ Slider ${sliderIndex + 1}: Found container and nav buttons`);
                
                // T√≠nh to√°n scroll amount: width c·ªßa 4 items (1 viewport)
                function getScrollAmount() {
                    const firstItem = scrollContainer.querySelector('.scroll-item');
                    if (!firstItem) return scrollContainer.clientWidth;
                    
                    // L·∫•y width c·ªßa 1 item v√† nh√¢n v·ªõi 4
                    const itemWidth = firstItem.offsetWidth;
                    const scrollAmount = itemWidth * 4;
                    return scrollAmount;
                }
                
                // H√†m scroll sang tr√°i (back)
                function scrollLeft() {
                    const scrollAmount = getScrollAmount();
                    const currentScroll = scrollContainer.scrollLeft;
                    const newScroll = Math.max(0, currentScroll - scrollAmount);
                    
                    scrollContainer.scrollTo({
                        left: newScroll,
                        behavior: 'smooth'
                    });
                    
                    console.log(`  ‚Üê Scrolled left: ${currentScroll} ‚Üí ${newScroll}`);
                }
                
                // H√†m scroll sang ph·∫£i (next)
                function scrollRight() {
                    const scrollAmount = getScrollAmount();
                    const currentScroll = scrollContainer.scrollLeft;
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                    const newScroll = Math.min(maxScroll, currentScroll + scrollAmount);
                    
                    scrollContainer.scrollTo({
                        left: newScroll,
                        behavior: 'smooth'
                    });
                    
                    console.log(`  ‚Üí Scrolled right: ${currentScroll} ‚Üí ${newScroll}`);
                }
                
                // Th√™m event listeners cho nav buttons
                navLeft.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    scrollLeft();
                });
                
                navRight.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    scrollRight();
                });
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i nav buttons d·ª±a tr√™n v·ªã tr√≠ scroll
                function updateNavButtons() {
                    const currentScroll = scrollContainer.scrollLeft;
                    const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                    const threshold = 10; // 10px threshold
                    
                    // ·∫®n/hi·ªán n√∫t left
                    if (currentScroll <= threshold) {
                        navLeft.classList.add('nav-hidden');
                    } else {
                        navLeft.classList.remove('nav-hidden');
                    }
                    
                    // ·∫®n/hi·ªán n√∫t right
                    if (currentScroll >= maxScroll - threshold) {
                        navRight.classList.add('nav-hidden');
                    } else {
                        navRight.classList.remove('nav-hidden');
                    }
                }
                
                // C·∫≠p nh·∫≠t nav buttons khi scroll
                scrollContainer.addEventListener('scroll', updateNavButtons);
                
                // C·∫≠p nh·∫≠t l·∫ßn ƒë·∫ßu
                updateNavButtons();
                
                console.log(`  ‚úÖ Slider ${sliderIndex + 1}: Navigation initialized`);
            });
            
            console.log(`üé† Custom slider navigation initialized for ${sliders.length} slider(s)`);
        }
    </script>
{% endblock %}

